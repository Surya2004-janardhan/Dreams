name: Wild-Life YT Daily Workflow

on:
  schedule:
    # Run at 8:00 AM UTC every day
    # Adjust timezone as needed (8:00 AM UTC)
    # - cron: "0 8 * * *"

  # Allow manual triggering from GitHub UI
  workflow_dispatch:

env:
  NODE_ENV: production

jobs:
  process-wildlife-videos:
    runs-on: ubuntu-latest

    timeout-minutes: 120

    strategy:
      matrix:
        node-version: [18.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install root dependencies
        run: npm ci
        working-directory: .

      - name: Install wild-life-yt-automation dependencies
        run: npm ci
        working-directory: ./wild-life-yt-automation

      - name: Create required directories
        run: |
          mkdir -p wild-life-yt-automation/downloaded_videos
          mkdir -p wild-life-yt-automation/processed_videos
          mkdir -p wild-life-yt-automation/logs
          mkdir -p wild-life-yt-automation/backups

      - name: Setup environment variables
        run: |
          # Copy .env.example to .env if .env doesn't exist
          if [ ! -f wild-life-yt-automation/.env ]; then
            cp wild-life-yt-automation/.env.example wild-life-yt-automation/.env
          fi
        shell: bash

      - name: Configure API credentials
        run: |
          # Create .env file with only needed secrets from GitHub
          cat > wild-life-yt-automation/.env << EOF
          EMAIL_USER=${{ secrets.EMAIL_USER }}
          EMAIL_PASS=${{ secrets.EMAIL_PASS }}
          RECIPIENT_EMAIL=${{ secrets.RECIPIENT_EMAIL }}
          EOF
        shell: bash

      - name: Setup Google credentials
        run: |
          # Decode and create credentials.json from secret (base64 encoded)
          echo "${{ secrets.NEW_JSON_FOR_WILD }}" | base64 -d > wild-life-yt-automation/credentials.json
          echo "âœ… Google credentials file created"
        shell: bash

      - name: Verify configuration
        run: |
          echo "ğŸ“‹ Checking directory structure..."
          ls -la wild-life-yt-automation/
          echo ""
          echo "ğŸ“¦ Checking Node version..."
          node --version
          npm --version
        shell: bash

      - name: Run video processor
        run: npm start
        working-directory: ./wild-life-yt-automation
        continue-on-error: true

      - name: Create backup of processed videos
        if: always()
        run: |
          if [ -d "wild-life-yt-automation/processed_videos" ]; then
            BACKUP_DIR="wild-life-yt-automation/backups/backup_$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            cp -r wild-life-yt-automation/processed_videos/* "$BACKUP_DIR/" 2>/dev/null || true
            echo "âœ… Backup created at: $BACKUP_DIR"
          fi
        shell: bash

      - name: Upload workflow logs as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-logs-${{ github.run_number }}
          path: |
            wild-life-yt-automation/logs/
            wild-life-yt-automation/backups/
          retention-days: 30

      - name: Send success notification
        if: success()
        run: |
          echo "âœ… Wild-Life YT Daily Workflow Completed Successfully"
          echo "ğŸ“… Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Send failure notification
        if: failure()
        run: |
          echo "âŒ Wild-Life YT Daily Workflow Failed"
          echo "ğŸ“… Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          exit 1

